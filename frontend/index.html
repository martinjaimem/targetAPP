<!DOCTYPE html>

<head>
    <link rel="manifest" href="/manifest.json" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src='/action_cable.js' type="text/javascript"></script>
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    <script>
        console.log(ActionCable)
        var OneSignal = window.OneSignal || [];
        OneSignal.push(function () {
            OneSignal.init({
                appId: "9e563f59-eb74-4574-8204-d4fc882a9796",
            });
        });
        (function () {
            this.App || (this.App = {});
        }).call(this);
        var the_user;
        var tokens = {};
    </script>
</head>
<html>

<body>
    <script>
        var loggedin = false;
    </script>
    user: <input type="text" id="email" value="michaelj23@gmail.com"><br>
    password: <input type="text" id="password" value="michaelj23"><br>
    <button id="login">Log in</button>
    <p id="test1">Not logged in</p>
    <!-- Conversation Id: <input type="text" name="LastName" value="1"> -->
    <button type="button" id="conversation"> Make user online </button>
    Online: <input type="checkbox" id="online">
    <p id="demo"></p>
    Message: <input id="message" type="text" name="LastName" value="My message">
    <button type="button" id="sendmessage"> Send </button>
    <ol>
        <li>Messages:</li>
    </ol>
    <script>
        function setpushtoken() {
            console.log('pressed set push token')
            OneSignal.getUserId(function (push_token) {
                console.log(the_user.data.id)
                $.ajax({
                    url: "http://localhost:3000/api/v1/users/" + the_user.data.id,
                    type: "PUT",
                    data: {
                        "user": {
                            "push_token": push_token
                        }
                    },
                    headers: {
                        'Access-Control-Allow-Origin': '*',
                        'access-token': tokens.accessToken,
                        'client': tokens.client,
                        'uid': tokens.uid
                    },
                    dataType: "json",
                    success: function (data, textStatus, request) {
                        console.log('succeed connecting')
                    },
                    error: function (dat) {
                        console.log(dat, 'llega')
                    }
                });
            }
            );
        }
        $("#conversation").click(function () {
            App.personalChat = App.cable.subscriptions.create(
                { channel: "ChatChannel", conversation_id: 1 },
                {
                    received: (data) => {
                        $("ol").append(" <li> [" + data['user_id'] + "] - " + data['content'] + "</li>");
                    },
                    sendMessage: function (messageBody) {
                        this.perform('send_message', { content: $("#message").val(), action: "new_message", user_id: the_user.data.id });
                    }
                }
            )
            $("#online").attr("checked", "checked");
        })
        $("#sendmessage").click(function () {
            App.personalChat.sendMessage('hola')
        })
        $("#setpushtoken").click(setpushtoken)
        $("#login").click(function () {
            $.ajax({
                url: "http://localhost:3000/api/v1/users/sign_in",
                type: "POST",
                data: {
                    "email": $("#email").val(),
                    "password": $("#password").val()
                },
                headers: { 'Access-Control-Allow-Origin': '*' },
                dataType: "json",
                success: function (data, textStatus, request) {
                    var accessToken = request.getResponseHeader('access-token');
                    tokens.accessToken = accessToken;
                    var uid = request.getResponseHeader('uid');
                    tokens.uid = uid;
                    var client = request.getResponseHeader('client');
                    tokens.client = client;
                    var loggedHeaders = { uid: uid, client: client, 'access-token': accessToken }
                    var user_id = data['id']
                    App.cable = ActionCable.createConsumer(
                        "ws://localhost:3000/cable?access-token=" + accessToken +
                        "&client=" + client +
                        "&uid=" + uid);
                    console.log('Logged in with access token: ', accessToken)
                    console.log('uid: ', uid)
                    console.log('client: ', client)
                    the_user = data
                    $("#test1").text("Logged in successfully");
                    setpushtoken()
                },
                error: function (dat) {
                    console.log(dat, 'llega')
                }
            });

        })

    </script>
</body>

</html>
